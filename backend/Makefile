.PHONY: help install run build deploy destroy migrate migrate-create migrate-down migrate-status clean test

# Variables
APP_NAME=expense-audio-api
BINARY_NAME=bootstrap
MIGRATIONS_DIR=./migrations

# Load .env file if it exists
ifneq (,$(wildcard ./.env))
    include .env
    export
endif

help: ## Show this help message
	@echo "Usage: make [target]"
	@echo ""
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Install dependencies and tools
	@echo "ğŸ“¦ Installing Go dependencies..."
	go mod download
	go mod tidy
	@echo "ğŸ”§ Installing goose..."
	go install github.com/pressly/goose/v3/cmd/goose@latest
	@echo "ğŸ”§ Installing swag..."
	go install github.com/swaggo/swag/cmd/swag@latest
	@echo "âœ… Installation complete"

run: ## Run the application locally
	@echo "ğŸš€ Starting server..."
	go run main.go

build: ## Build the application for local testing
	@echo "ğŸ”¨ Building application..."
	go build -o $(APP_NAME) .
	@echo "âœ… Build complete: ./$(APP_NAME)"

build-lambda: ## Build Lambda binary for deployment
	@echo "ğŸ”¨ Building Lambda binary..."
	GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -tags lambda.norpc -o $(BINARY_NAME) main.go
	@echo "âœ… Lambda binary built: ./$(BINARY_NAME)"

migrate: ## Run all pending migrations
	@echo "ğŸ”„ Running database migrations..."
	@if [ -z "$(DB_URL)" ]; then \
		echo "âŒ Error: DB_URL not set. Please set it in .env or environment"; \
		exit 1; \
	fi
	goose -dir $(MIGRATIONS_DIR) postgres "$(DB_URL)" up
	@echo "âœ… Migrations complete"

migrate-down: ## Rollback the last migration
	@echo "â¬‡ï¸  Rolling back last migration..."
	@if [ -z "$(DB_URL)" ]; then \
		echo "âŒ Error: DB_URL not set. Please set it in .env or environment"; \
		exit 1; \
	fi
	goose -dir $(MIGRATIONS_DIR) postgres "$(DB_URL)" down
	@echo "âœ… Rollback complete"

migrate-status: ## Show migration status
	@echo "ğŸ“Š Migration status:"
	@if [ -z "$(DB_URL)" ]; then \
		echo "âŒ Error: DB_URL not set. Please set it in .env or environment"; \
		exit 1; \
	fi
	goose -dir $(MIGRATIONS_DIR) postgres "$(DB_URL)" status

migrate-create: ## Create a new migration (usage: make migrate-create NAME=migration_name)
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ Error: NAME not provided. Usage: make migrate-create NAME=migration_name"; \
		exit 1; \
	fi
	@echo "ğŸ“ Creating new migration: $(NAME)"
	goose -dir $(MIGRATIONS_DIR) create $(NAME) sql
	@echo "âœ… Migration created in $(MIGRATIONS_DIR)/"

deploy: build-lambda ## Deploy to AWS Lambda via Terraform
	@echo "â˜ï¸  Deploying to AWS Lambda..."
	cd terraform && terraform init && terraform apply -auto-approve
	@echo "âœ… Deployment complete"

deploy-plan: ## Show Terraform deployment plan
	@echo "ğŸ“‹ Showing deployment plan..."
	cd terraform && terraform init && terraform plan

destroy: ## Destroy AWS Lambda deployment
	@echo "ğŸ—‘ï¸  Destroying AWS Lambda deployment..."
	@read -p "Are you sure you want to destroy? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		cd terraform && terraform destroy -auto-approve; \
		echo "âœ… Resources destroyed"; \
	else \
		echo "âŒ Destroy cancelled"; \
	fi

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -f $(APP_NAME) $(BINARY_NAME) lambda.zip
	rm -rf terraform/.terraform terraform/terraform.tfstate*
	@echo "âœ… Clean complete"

test: ## Run tests
	@echo "ğŸ§ª Running tests..."
	go test -v ./...

fmt: ## Format code
	@echo "ğŸ¨ Formatting code..."
	go fmt ./...
	@echo "âœ… Format complete"

swagger: ## Generate Swagger documentation
	@echo "ğŸ“š Generating Swagger documentation..."
	@if ! command -v swag &> /dev/null; then \
		echo "âš ï¸  swag not installed. Installing..."; \
		go install github.com/swaggo/swag/cmd/swag@latest; \
	fi
	swag init
	@echo "âœ… Swagger documentation generated in ./docs"

lint: ## Run linter
	@echo "ğŸ” Running linter..."
	@if ! command -v golangci-lint &> /dev/null; then \
		echo "âš ï¸  golangci-lint not installed. Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
	else \
		golangci-lint run; \
	fi

dev: ## Run in development mode with live reload (requires air)
	@echo "ğŸ”„ Starting development server..."
	@if ! command -v air &> /dev/null; then \
		echo "âš ï¸  air not installed. Installing..."; \
		go install github.com/cosmtrek/air@latest; \
	fi
	air

logs: ## Show Lambda logs (requires AWS CLI)
	@echo "ğŸ“œ Fetching Lambda logs..."
	aws logs tail /aws/lambda/upload-audio --follow

# Docker targets
docker-build: ## Build Docker image
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(APP_NAME):latest .

docker-run: ## Run Docker container
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8080:8080 --env-file .env $(APP_NAME):latest
